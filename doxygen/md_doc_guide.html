<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libsqsh: Working with Archives</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libsqsh<span id="projectnumber">&#160;v1.3.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Working with Archives </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md10">Introduction</a></li>
<li class="level1"><a href="#autotoc_md11">Reading files in the archive</a><ul><li class="level2"><a href="#autotoc_md12">Simple</a></li>
<li class="level2"><a href="#autotoc_md13">Advanced: File Iterators</a></li>
<li class="level2"><a href="#autotoc_md14">Advanced: File Reader</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="working_with_archives"></a></p>
<h1><a class="anchor" id="autotoc_md10"></a>
Introduction</h1>
<p>The <a class="el" href="structSqshArchive.html">SqshArchive</a> struct represents a squashfs archive. It is created by calling <a class="el" href="structSqshArchive.html#a3db88cfffd255b3781e329c0f660ba79">sqsh_archive_open()</a> and is destroyed by calling <a class="el" href="structSqshArchive.html#ad9c8077e5c6e3d98cff588e203be15e1">sqsh_archive_close()</a>. If you need better control over the archive creation you can use the <a class="el" href="structSqshArchive.html#a3db88cfffd255b3781e329c0f660ba79">sqsh_archive_open()</a> function, which accepts a <a class="el" href="structSqshConfig.html">SqshConfig</a> struct that gives you more control over the archive and better error reporting.</p>
<p>Opening: </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structSqshArchive.html">SqshArchive</a> *archive = <a class="code hl_function" href="structSqshArchive.html#a3db88cfffd255b3781e329c0f660ba79">sqsh_archive_open</a>(<span class="stringliteral">&quot;archive.squashfs&quot;</span>);</div>
<div class="ttc" id="astructSqshArchive_html"><div class="ttname"><a href="structSqshArchive.html">SqshArchive</a></div><div class="ttdef"><b>Definition:</b> <a href="sqsh__archive__private_8h_source.html#l00212">sqsh_archive_private.h:212</a></div></div>
<div class="ttc" id="astructSqshArchive_html_a3db88cfffd255b3781e329c0f660ba79"><div class="ttname"><a href="structSqshArchive.html#a3db88cfffd255b3781e329c0f660ba79">SqshArchive::sqsh_archive_open</a></div><div class="ttdeci">SQSH_NO_UNUSED struct SqshArchive * sqsh_archive_open(const void *source, const struct SqshConfig *config, int *err)</div><div class="ttdoc">initializes a archive context in heap.</div></div>
</div><!-- fragment --><p>Closing: </p><div class="fragment"><div class="line"><a class="code hl_function" href="structSqshArchive.html#ad9c8077e5c6e3d98cff588e203be15e1">sqsh_archive_close</a>(archive);</div>
<div class="ttc" id="astructSqshArchive_html_ad9c8077e5c6e3d98cff588e203be15e1"><div class="ttname"><a href="structSqshArchive.html#ad9c8077e5c6e3d98cff588e203be15e1">SqshArchive::sqsh_archive_close</a></div><div class="ttdeci">int sqsh_archive_close(struct SqshArchive *archive)</div><div class="ttdoc">Frees the resources used by a Sqsh instance.</div></div>
</div><!-- fragment --><p>Opening with more control: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> err = 0;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structSqshConfig.html">SqshConfig</a> config = {</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structSqshArchive.html">SqshArchive</a> *archive = sqsh_archive_new(<span class="stringliteral">&quot;archive.sqsh&quot;</span>, &amp;config, &amp;err);</div>
<div class="line"><span class="keywordflow">if</span> (err != 0) {</div>
<div class="line">    <a class="code hl_function" href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a>(err);</div>
<div class="line">}</div>
<div class="ttc" id="asqsh__error_8h_html_a4154510d5a364e668e4667aae0678e6a"><div class="ttname"><a href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a></div><div class="ttdeci">void sqsh_perror(int error_code, const char *msg)</div><div class="ttdoc">Print the error message for the given error code.</div></div>
<div class="ttc" id="astructSqshConfig_html"><div class="ttname"><a href="structSqshConfig.html">SqshConfig</a></div><div class="ttdoc">The SqshConfig struct contains all the configuration options for a sqsh session.</div><div class="ttdef"><b>Definition:</b> <a href="sqsh__archive_8h_source.html#l00375">sqsh_archive.h:375</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
Reading files in the archive</h1>
<h2><a class="anchor" id="autotoc_md12"></a>
Simple</h2>
<p>The simplest way to read a file in the archive is to use <a class="el" href="sqsh__easy_8h.html#afccc90b3b193597d84a12893f10ca96a">sqsh_easy_file_content()</a>. This function returns a pointer to the contents of the file in the archive. The pointer is heap allocated and must be freed by the caller. The allocated buffer is null terminated. If the file itself contains null bytes, you can get the file size by calling <a class="el" href="sqsh__easy_8h.html#a3793b8e17ed31dc29e81751f175a5a55">sqsh_easy_file_size()</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span> *content = <a class="code hl_function" href="sqsh__easy_8h.html#afccc90b3b193597d84a12893f10ca96a">sqsh_easy_file_content</a>(archive, <span class="stringliteral">&quot;/path/to/file.txt&quot;</span>);</div>
<div class="line"><span class="keywordtype">size_t</span> size = <a class="code hl_function" href="sqsh__easy_8h.html#a3793b8e17ed31dc29e81751f175a5a55">sqsh_easy_file_size</a>(archive, <span class="stringliteral">&quot;/path/to/file.txt&quot;</span>);</div>
<div class="line">fwrite(content, 1, size, stdout);</div>
<div class="line">free(content);</div>
<div class="ttc" id="asqsh__easy_8h_html_a3793b8e17ed31dc29e81751f175a5a55"><div class="ttname"><a href="sqsh__easy_8h.html#a3793b8e17ed31dc29e81751f175a5a55">sqsh_easy_file_size</a></div><div class="ttdeci">size_t sqsh_easy_file_size(struct SqshArchive *archive, const char *path, int *err)</div><div class="ttdoc">retrieves the size of a file.</div></div>
<div class="ttc" id="asqsh__easy_8h_html_afccc90b3b193597d84a12893f10ca96a"><div class="ttname"><a href="sqsh__easy_8h.html#afccc90b3b193597d84a12893f10ca96a">sqsh_easy_file_content</a></div><div class="ttdeci">uint8_t * sqsh_easy_file_content(struct SqshArchive *archive, const char *path, int *err)</div><div class="ttdoc">retrieves the content of a file.</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
Advanced: File Iterators</h2>
<p>The simple API is fine for small files, but for larger files it is better to use the <a class="el" href="structSqshFileIterator.html">SqshFileIterator</a>. The iterator allows you to read the file in chunks, which is more efficient than reading the entire file into memory at once.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> err = 0;</div>
<div class="line"><span class="keyword">struct </span>SqshInode *inode = sqsh_open(archive, <span class="stringliteral">&quot;/path/to/file.txt&quot;</span>, &amp;err);</div>
<div class="line"><span class="keywordflow">if</span> (err != 0) {</div>
<div class="line">    <a class="code hl_function" href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a>(err);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structSqshFileIterator.html">SqshFileIterator</a> *it = <a class="code hl_function" href="structSqshFileIterator.html#a6d67e70bb91e118127820f941d703620">sqsh_file_iterator_new</a>(archive, <span class="stringliteral">&quot;/path/to/file.txt&quot;</span>, &amp;err);</div>
<div class="line"><span class="keywordflow">if</span> (err != 0) {</div>
<div class="line">    <a class="code hl_function" href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a>(err);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">while</span> ((err = <a class="code hl_function" href="structSqshFileIterator.html#a7309272bb1e8a88e33a11655672e5fd3">sqsh_file_iterator_next</a>(it)) &gt; 0) {</div>
<div class="line">    <span class="keyword">const</span> uint8_t *data = <a class="code hl_function" href="structSqshFileIterator.html#a97bb645391542f4522f7a2db91abf0bf">sqsh_file_iterator_data</a>(it);</div>
<div class="line">    <span class="keywordtype">size_t</span> size = <a class="code hl_function" href="structSqshFileIterator.html#a1caf211b699f571cda3dc3a9db81ba21">sqsh_file_iterator_size</a>(it);</div>
<div class="line">    fwrite(data, 1, size, stdout);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">if</span> (err != 0) {</div>
<div class="line">    <a class="code hl_function" href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a>(err);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><a class="code hl_function" href="structSqshFileIterator.html#a863c75467913a205112ecd3339b84e6a">sqsh_file_iterator_free</a>(it);</div>
<div class="ttc" id="astructSqshFileIterator_html"><div class="ttname"><a href="structSqshFileIterator.html">SqshFileIterator</a></div><div class="ttdoc">An iterator over the contents of a file.</div><div class="ttdef"><b>Definition:</b> <a href="sqsh__file__private_8h_source.html#l00126">sqsh_file_private.h:126</a></div></div>
<div class="ttc" id="astructSqshFileIterator_html_a1caf211b699f571cda3dc3a9db81ba21"><div class="ttname"><a href="structSqshFileIterator.html#a1caf211b699f571cda3dc3a9db81ba21">SqshFileIterator::sqsh_file_iterator_size</a></div><div class="ttdeci">SQSH_NO_UNUSED size_t sqsh_file_iterator_size(const struct SqshFileIterator *iterator)</div><div class="ttdoc">Gets the size of the data currently in the file iterator.</div></div>
<div class="ttc" id="astructSqshFileIterator_html_a6d67e70bb91e118127820f941d703620"><div class="ttname"><a href="structSqshFileIterator.html#a6d67e70bb91e118127820f941d703620">SqshFileIterator::sqsh_file_iterator_new</a></div><div class="ttdeci">SQSH_NO_UNUSED struct SqshFileIterator * sqsh_file_iterator_new(const struct SqshFile *file, int *err)</div><div class="ttdoc">Creates a new SqshFileIterator struct and initializes it.</div></div>
<div class="ttc" id="astructSqshFileIterator_html_a7309272bb1e8a88e33a11655672e5fd3"><div class="ttname"><a href="structSqshFileIterator.html#a7309272bb1e8a88e33a11655672e5fd3">SqshFileIterator::sqsh_file_iterator_next</a></div><div class="ttdeci">SQSH_NO_UNUSED bool sqsh_file_iterator_next(struct SqshFileIterator *iterator, size_t desired_size, int *err)</div><div class="ttdoc">Reads a certain amount of data from the file iterator.</div></div>
<div class="ttc" id="astructSqshFileIterator_html_a863c75467913a205112ecd3339b84e6a"><div class="ttname"><a href="structSqshFileIterator.html#a863c75467913a205112ecd3339b84e6a">SqshFileIterator::sqsh_file_iterator_free</a></div><div class="ttdeci">int sqsh_file_iterator_free(struct SqshFileIterator *iterator)</div><div class="ttdoc">Frees the resources used by a SqshFileIterator struct.</div></div>
<div class="ttc" id="astructSqshFileIterator_html_a97bb645391542f4522f7a2db91abf0bf"><div class="ttname"><a href="structSqshFileIterator.html#a97bb645391542f4522f7a2db91abf0bf">SqshFileIterator::sqsh_file_iterator_data</a></div><div class="ttdeci">SQSH_NO_UNUSED const uint8_t * sqsh_file_iterator_data(const struct SqshFileIterator *iterator)</div><div class="ttdoc">Gets a pointer to the current data in the file iterator.</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md14"></a>
Advanced: File Reader</h2>
<p>If you need more control over the ranges to be read from the file, you can use the <a class="el" href="structSqshFileReader.html">SqshFileReader</a> API. This API allows you to read arbitrary ranges from the file.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> err = 0;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structSqshFileReader.html">SqshFileReader</a> *reader = <a class="code hl_function" href="structSqshFileReader.html#ae375a343ef87568f5c1fdafc8c43da65">sqsh_file_reader_new</a>(archive, <span class="stringliteral">&quot;/path/to/file.txt&quot;</span>, &amp;err);</div>
<div class="line"><span class="keywordflow">if</span> (err != 0) {</div>
<div class="line">    <a class="code hl_function" href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a>(err);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line">err = <a class="code hl_function" href="structSqshFileReader.html#aedfe992063ddd2e6f807da715becfbca">sqsh_file_reader_advance</a>(reader, 0, 10);</div>
<div class="line"><span class="keywordflow">if</span> (err != 0) {</div>
<div class="line">    <a class="code hl_function" href="sqsh__error_8h.html#a4154510d5a364e668e4667aae0678e6a">sqsh_perror</a>(err);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">const</span> uint8_t *data = <a class="code hl_function" href="structSqshFileReader.html#a218525dec2fd6f6eedf9b55067d993c9">sqsh_file_reader_data</a>(reader);</div>
<div class="line"><span class="keywordtype">size_t</span> size = <a class="code hl_function" href="structSqshFileReader.html#a938d5d35085406abfa7d79650548d392">sqsh_file_reader_size</a>(reader);</div>
<div class="line">fwrite(data, 1, size, stdout);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="structSqshFileReader.html#a9d0e1dc2c431ca3525b9a3e70af8f2c1">sqsh_file_reader_free</a>(reader);</div>
<div class="ttc" id="astructSqshFileReader_html"><div class="ttname"><a href="structSqshFileReader.html">SqshFileReader</a></div><div class="ttdoc">A reader over the contents of a file.</div><div class="ttdef"><b>Definition:</b> <a href="sqsh__file__private_8h_source.html#l00174">sqsh_file_private.h:174</a></div></div>
<div class="ttc" id="astructSqshFileReader_html_a218525dec2fd6f6eedf9b55067d993c9"><div class="ttname"><a href="structSqshFileReader.html#a218525dec2fd6f6eedf9b55067d993c9">SqshFileReader::sqsh_file_reader_data</a></div><div class="ttdeci">const uint8_t * sqsh_file_reader_data(const struct SqshFileReader *reader)</div><div class="ttdoc">Gets a pointer to the current data in the file reader.</div></div>
<div class="ttc" id="astructSqshFileReader_html_a938d5d35085406abfa7d79650548d392"><div class="ttname"><a href="structSqshFileReader.html#a938d5d35085406abfa7d79650548d392">SqshFileReader::sqsh_file_reader_size</a></div><div class="ttdeci">size_t sqsh_file_reader_size(const struct SqshFileReader *reader)</div><div class="ttdoc">Gets the size of the current data in the file reader.</div></div>
<div class="ttc" id="astructSqshFileReader_html_a9d0e1dc2c431ca3525b9a3e70af8f2c1"><div class="ttname"><a href="structSqshFileReader.html#a9d0e1dc2c431ca3525b9a3e70af8f2c1">SqshFileReader::sqsh_file_reader_free</a></div><div class="ttdeci">int sqsh_file_reader_free(struct SqshFileReader *reader)</div><div class="ttdoc">Cleans up resources used by a SqshFileReader struct.</div></div>
<div class="ttc" id="astructSqshFileReader_html_ae375a343ef87568f5c1fdafc8c43da65"><div class="ttname"><a href="structSqshFileReader.html#ae375a343ef87568f5c1fdafc8c43da65">SqshFileReader::sqsh_file_reader_new</a></div><div class="ttdeci">struct SqshFileReader * sqsh_file_reader_new(const struct SqshFile *file, int *err)</div><div class="ttdoc">Initializes a SqshFileReader struct.</div></div>
<div class="ttc" id="astructSqshFileReader_html_aedfe992063ddd2e6f807da715becfbca"><div class="ttname"><a href="structSqshFileReader.html#aedfe992063ddd2e6f807da715becfbca">SqshFileReader::sqsh_file_reader_advance</a></div><div class="ttdeci">int sqsh_file_reader_advance(struct SqshFileReader *reader, sqsh_index_t offset, size_t size)</div><div class="ttdoc">Advances the file reader by a certain amount of data and presents size bytes of data to the user.</div></div>
</div><!-- fragment --><p>This example reads the first 10 bytes of the file. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
